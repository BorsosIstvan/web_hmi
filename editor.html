<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SCADA Editor</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>
  <div id="toolbar">
    <button onclick="createButton()">âž• Knop toevoegen</button>
    <button onclick="createLamp()">ðŸ’¡ Lamp toevoegen</button>
  </div>

  <div id="canvas"></div>

  <script>
    const mqttClient = mqtt.connect("ws://raspberrypi.local:9001");

    mqttClient.on("connect", () => {
      console.log("MQTT verbonden");
      // Abonneer op bestaande topics van lampen
      document.querySelectorAll(".lamp").forEach(lamp => {
        if (lamp.dataset.topic) {
          mqttClient.subscribe(lamp.dataset.topic);
        }
      });
    });

    mqttClient.on("message", (topic, message) => {
      document.querySelectorAll(".lamp").forEach(lamp => {
        if (lamp.dataset.topic === topic) {
          const msg = message.toString();
          lamp.style.backgroundColor = msg === "on" ? "green" : "red";
        }
      });
    });

    function createButton() {
      const button = document.createElement("div");
      button.className = "object button";
      button.innerText = "Knop";
      button.dataset.name = "Knop";
      makeDraggable(button);
      button.addEventListener("click", () => {
        const topic = button.dataset.topic;
        const value = button.dataset.value || "on";
        if (topic && mqttClient?.connected) {
          mqttClient.publish(topic, value);
        }
      });
      addContextMenu(button);
      document.getElementById("canvas").appendChild(button);
    }

    function createLamp() {
      const lamp = document.createElement("div");
      lamp.className = "object lamp";
      lamp.style.backgroundColor = "gray";
      lamp.dataset.name = "Lamp";
      makeDraggable(lamp);
      addContextMenu(lamp);
      document.getElementById("canvas").appendChild(lamp);
    }

    function makeDraggable(el) {
      el.onmousedown = function (e) {
        let shiftX = e.clientX - el.getBoundingClientRect().left;
        let shiftY = e.clientY - el.getBoundingClientRect().top;

        function moveAt(pageX, pageY) {
          el.style.left = pageX - shiftX + 'px';
          el.style.top = pageY - shiftY + 'px';
        }

        function onMouseMove(event) {
          moveAt(event.pageX, event.pageY);
        }

        document.addEventListener('mousemove', onMouseMove);

        el.onmouseup = function () {
          document.removeEventListener('mousemove', onMouseMove);
          el.onmouseup = null;
        };
      };
      el.ondragstart = function () {
        return false;
      };
    }

    function addContextMenu(object) {
      object.addEventListener("contextmenu", (e) => {
        e.preventDefault();
        const action = prompt("Actie: verwijderen (v), eigenschappen (e)");
        if (action === "v") {
          object.remove();
        } else if (action === "e") {
          showPropertiesPanel(object);
        }
      });
    }

    function showPropertiesPanel(object) {
      const newName = prompt("Naam van object:", object.dataset.name || "");
      if (newName !== null) {
        object.dataset.name = newName;
        object.innerText = newName;
      }

      const newTopic = prompt("MQTT-topic:", object.dataset.topic || "");
      if (newTopic !== null) {
        object.dataset.topic = newTopic;
        if (object.classList.contains("lamp") && mqttClient?.connected) {
          mqttClient.subscribe(newTopic);
        }
      }

      if (object.classList.contains("button")) {
        const newValue = prompt("MQTT-waarde bij klik:", object.dataset.value || "on");
        if (newValue !== null) {
          object.dataset.value = newValue;
        }
      }
    }
  </script>
</body>
</html>
