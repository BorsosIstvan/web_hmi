<!DOCTYPE html>
<html>
<head>
  <title>SCADA HMI Editor</title>
  <style>
    body { font-family: sans-serif; margin: 0; }
    #toolbar { background: #eee; padding: 10px; border-bottom: 1px solid #ccc; }
    #canvas { position: relative; width: 100%; height: 90vh; background: #f9f9f9; }
    .lamp {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: red;
      position: absolute;
      cursor: move;
      border: 2px solid #444;
    }
  </style>
</head>
<body>

<div id="toolbar">
  <button onclick="addLamp()">+ Lamp</button>
</div>
<div id="canvas"></div>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
  const canvas = document.getElementById('canvas');
  const client = mqtt.connect('ws://poci.n-soft.net:9001');

  client.on('connect', () => {
    console.log('MQTT verbonden');
  });

  let lampCount = 0;

  function addLamp() {
    lampCount++;
    const lampId = 'lamp' + lampCount;
    const lamp = document.createElement('div');
    lamp.className = 'lamp';
    lamp.style.left = (20 + lampCount * 60) + 'px';
    lamp.style.top = '50px';
    lamp.id = lampId;
    lamp.dataset.topic = 'hmi/' + lampId;
    canvas.appendChild(lamp);

    // Subscriben op het topic
    client.subscribe(lamp.dataset.topic);

    // Klik = toggle kleur + publish
    lamp.addEventListener('click', () => {
      const isOn = lamp.style.backgroundColor === 'green';
      const newState = isOn ? 'off' : 'on';
      lamp.style.backgroundColor = isOn ? 'red' : 'green';
      client.publish(lamp.dataset.topic, newState);
    });

    // Drag functionaliteit
    lamp.onmousedown = function (e) {
      const offsetX = e.offsetX;
      const offsetY = e.offsetY;
      function moveAt(x, y) {
        lamp.style.left = x - offsetX + 'px';
        lamp.style.top = y - offsetY + 'px';
      }
      function onMouseMove(e) {
        moveAt(e.pageX, e.pageY);
      }
      document.addEventListener('mousemove', onMouseMove);
      lamp.onmouseup = () => {
        document.removeEventListener('mousemove', onMouseMove);
        lamp.onmouseup = null;
      };
    };

    // Ontvang berichten
    client.on('message', (topic, message) => {
      if (topic === lamp.dataset.topic) {
        lamp.style.backgroundColor = message.toString() === 'on' ? 'green' : 'red';
      }
    });
  }
</script>

</body>
</html>
