<!DOCTYPE html>
<html>
<head>
  <title>SCADA HMI Editor</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 0; }
    #toolbar { padding: 10px; background: #eee; }
    #canvas {
      position: relative;
      height: 90vh;
      background: #f9f9f9;
      border: 1px solid #ccc;
      overflow: hidden;
    }
    .lamp, .hmi-button {
      position: absolute;
      user-select: none;
      cursor: move;
    }
    .lamp {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: red;
    }
    .hmi-button {
      width: 80px;
      height: 30px;
      background: #007bff;
      color: white;
      text-align: center;
      line-height: 30px;
      border-radius: 4px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="toolbar">
    <button id="addLamp">+ Lamp</button>
    <button id="addButton">+ Knop</button>
  </div>
  <div id="canvas"></div>

  <script>
    const client = mqtt.connect("ws://raspberrypi.local:9001");

    client.on('connect', () => {
      console.log("MQTT verbonden");
    });

    let dragItem = null;
    let offsetX = 0, offsetY = 0;

    const canvas = document.getElementById('canvas');

    function createLamp(x = 100, y = 100) {
      const lamp = document.createElement('div');
      lamp.className = 'lamp';
      lamp.style.left = x + 'px';
      lamp.style.top = y + 'px';
      lamp.dataset.state = 'off';
      lamp.dataset.topic = 'hmi/led';
      canvas.appendChild(lamp);

      lamp.addEventListener('click', (e) => {
        if (dragItem) return;
        const newState = lamp.dataset.state === 'on' ? 'off' : 'on';
        lamp.dataset.state = newState;
        lamp.style.background = newState === 'on' ? 'green' : 'red';
        client.publish(lamp.dataset.topic, newState);
      });

      lamp.addEventListener('mousedown', (e) => {
        dragItem = lamp;
        offsetX = e.offsetX;
        offsetY = e.offsetY;
      });

      client.subscribe(lamp.dataset.topic);
    }

    function createButton(x = 150, y = 100) {
      const button = document.createElement('div');
      button.className = 'hmi-button';
      button.style.left = x + 'px';
      button.style.top = y + 'px';
      button.textContent = 'Druk mij';
      button.dataset.topic = 'hmi/button1';
      canvas.appendChild(button);

      button.addEventListener('click', (e) => {
        if (dragItem) return;
        client.publish(button.dataset.topic, 'pressed');
        console.log('MQTT: pressed â†’', button.dataset.topic);
      });

      button.addEventListener('mousedown', (e) => {
        dragItem = button;
        offsetX = e.offsetX;
        offsetY = e.offsetY;
      });
    }

    canvas.addEventListener('mousemove', (e) => {
      if (dragItem) {
        dragItem.style.left = (e.clientX - offsetX) + 'px';
        dragItem.style.top = (e.clientY - offsetY - canvas.getBoundingClientRect().top) + 'px';
      }
    });

    window.addEventListener('mouseup', () => {
      dragItem = null;
    });

    client.on('message', (topic, message) => {
      const lamps = document.querySelectorAll('.lamp');
      lamps.forEach(lamp => {
        if (lamp.dataset.topic === topic) {
          const msg = message.toString();
          lamp.dataset.state = msg;
          lamp.style.background = msg === 'on' ? 'green' : 'red';
        }
      });
    });

    document.getElementById('addLamp').addEventListener('click', () => {
      createLamp();
    });

    document.getElementById('addButton').addEventListener('click', () => {
      createButton();
    });
  </script>
</body>
</html>
