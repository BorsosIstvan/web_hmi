<!DOCTYPE html>
<html>
<head>
  <title>SCADA HMI Editor</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 0; }
    #toolbar { padding: 10px; background: #eee; }
    #canvas {
      position: relative;
      height: 90vh;
      background: #f9f9f9;
      border: 1px solid #ccc;
      overflow: hidden;
    }
    .lamp, .hmi-button {
      position: absolute;
      user-select: none;
      cursor: move;
    }
    .lamp {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: red;
    }
    .hmi-button {
      width: 80px;
      height: 30px;
      background: #007bff;
      color: white;
      text-align: center;
      line-height: 30px;
      border-radius: 4px;
      font-size: 14px;
    }
    /* Popup styling */
    #popup {
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border: 1px solid #888;
      padding: 15px;
      z-index: 999;
      display: none;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    #popup input {
      display: block;
      width: 200px;
      margin-bottom: 10px;
      padding: 4px;
    }
    #popup button {
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div id="toolbar">
    <button id="addLamp">+ Lamp</button>
    <button id="addButton">+ Knop</button>
  </div>
  <div id="canvas"></div>

  <!-- Popup -->
  <div id="popup">
    <label>Titel: <input type="text" id="popupTitle"></label>
    <label>Topic: <input type="text" id="popupTopic"></label>
    <label id="popupMessageLabel">Bericht: <input type="text" id="popupMessage"></label>
    <button id="popupSave">Opslaan</button>
    <button id="popupCancel">Annuleren</button>
  </div>

  <script>
    const client = mqtt.connect("ws://raspberrypi.local:9001");
    client.on('connect', () => console.log("MQTT verbonden"));

    const canvas = document.getElementById('canvas');
    let dragItem = null, offsetX = 0, offsetY = 0;

    const popup = document.getElementById('popup');
    const popupTitle = document.getElementById('popupTitle');
    const popupTopic = document.getElementById('popupTopic');
    const popupMessage = document.getElementById('popupMessage');
    const popupMessageLabel = document.getElementById('popupMessageLabel');
    let currentElement = null;

    function openPopupFor(element) {
      popupTitle.value = element.textContent || '';
      popupTopic.value = element.dataset.topic || '';
      popupMessage.value = element.dataset.message || '';
      popupMessageLabel.style.display = element.classList.contains('hmi-button') ? 'block' : 'none';
      popup.style.display = 'block';
      currentElement = element;
    }

    function closePopup() {
      popup.style.display = 'none';
      currentElement = null;
    }

    document.getElementById('popupSave').onclick = () => {
      if (!currentElement) return;
      currentElement.dataset.topic = popupTopic.value;
      currentElement.textContent = popupTitle.value;
      if (currentElement.classList.contains('hmi-button')) {
        currentElement.dataset.message = popupMessage.value;
      }
      closePopup();
    };

    document.getElementById('popupCancel').onclick = closePopup;

    function createLamp(x = 100, y = 100) {
      const lamp = document.createElement('div');
      lamp.className = 'lamp';
      lamp.style.left = x + 'px';
      lamp.style.top = y + 'px';
      lamp.dataset.state = 'off';
      lamp.dataset.topic = 'hmi/led';
      canvas.appendChild(lamp);

      lamp.addEventListener('click', (e) => {
        if (dragItem) return;
        const newState = lamp.dataset.state === 'on' ? 'off' : 'on';
        lamp.dataset.state = newState;
        lamp.style.background = newState === 'on' ? 'green' : 'red';
        client.publish(lamp.dataset.topic, newState);
      });

      lamp.addEventListener('mousedown', (e) => {
        dragItem = lamp;
        offsetX = e.offsetX;
        offsetY = e.offsetY;
      });

      lamp.addEventListener('dblclick', (e) => openPopupFor(lamp));

      client.subscribe(lamp.dataset.topic);
    }

    function createButton(x = 150, y = 100) {
      const button = document.createElement('div');
      button.className = 'hmi-button';
      button.style.left = x + 'px';
      button.style.top = y + 'px';
      button.textContent = 'Druk mij';
      button.dataset.topic = 'hmi/button1';
      button.dataset.message = 'pressed';
      canvas.appendChild(button);

      button.addEventListener('click', (e) => {
        if (dragItem) return;
        const msg = button.dataset.message || 'pressed';
        client.publish(button.dataset.topic, msg);
        console.log('MQTT gestuurd:', msg, 'naar', button.dataset.topic);
      });

      button.addEventListener('mousedown', (e) => {
        dragItem = button;
        offsetX = e.offsetX;
        offsetY = e.offsetY;
      });

      button.addEventListener('dblclick', (e) => openPopupFor(button));
    }

    canvas.addEventListener('mousemove', (e) => {
      if (dragItem) {
        dragItem.style.left = (e.clientX - offsetX) + 'px';
        dragItem.style.top = (e.clientY - offsetY - canvas.getBoundingClientRect().top) + 'px';
      }
    });

    window.addEventListener('mouseup', () => {
      dragItem = null;
    });

    client.on('message', (topic, message) => {
      const lamps = document.querySelectorAll('.lamp');
      lamps.forEach(lamp => {
        if (lamp.dataset.topic === topic) {
          const msg = message.toString();
          lamp.dataset.state = msg;
          lamp.style.background = msg === 'on' ? 'green' : 'red';
        }
      });
    });

    document.getElementById('addLamp').addEventListener('click', () => {
      createLamp();
    });

    document.getElementById('addButton').addEventListener('click', () => {
      createButton();
    });
  </script>
</body>
</html>
